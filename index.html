<html>
<head>
  <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="js/vendor/zepto.min.js"></script>
  <script src="js/vendor/mqttws31.min.js"></script>
  <script src="js/vendor/fastclick.min.js"></script>
  <script src="js/backend.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/packettimer.js"></script>
  <script src="js/runlog.js"></script>
  <script src="js/util.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>TTN EXPLORER</header>
  
  <!-- Page #settings -->
  <div class="page" id="settings">
    <form>
      <label for="devEui">Dev EUI </label>
      <input type="text" name="devEui"></input>

      <label for="appEui">App EUI </label>
      <input type="text" name="appEui"></input>

      <label for="accessKeys">Access Keys </label>
      <input type="text" name="accessKeys"></input>
      
      <label for="shareResults">Share results</label>
      <select name="shareResults">
        <option value="1">Yes</option>
        <option value="0">No</option>
      </select>
      <p>
        Choose if you want to share your measurements with the community (Please do!)
      </p>
      <p>
        <button id="startBtn">START SESSION</button>
      </p>
    </form>
  </div>
  
  <!-- Page #run -->
  <div id="run" class="page">
    <p class="info"></p>
    <table class="log">
      <thead>
        <tr>
          <th>Time</th>
          <th>GWs</th>
          <th>Acc</th>
          <th>SNR</th>
          <th>Freq</th>
          <th>DR</th>
          <th>RSSI</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <p>
      <button id="stopBtn">STOP SESSION</button>
    </p>
  </div>
  <!-- #run end -->
  
  <script>
  "use strict";
  
  var accuracyTreshold = 100000;
  
  /*********************************************************************
   * Page: #settings
   ********************************************************************/
  
  $("#settings").on("willshow", function(ev) {
    window.settings = new Settings("#settings form");
    settings.load();
  })
  .find("#startBtn").on("click", function(ev) {
    ev.preventDefault();
    var err = settings.validate();
    if (!err) {
      settings.save();
      navigate("#run");
    } else {
      alert(err)
    }
  });
  
  /*********************************************************************
   * Page: #run
   ********************************************************************/
  
  $("#run").on("willshow", function(ev) {
    var $page = $(this);
    var packetTimer = new PacketTimer($("#run .info"));
    var backend = new Backend(settings.get("appEui"), settings.get("accessKeys"));
    var runLog = new RunLog($page.find(".log tbody"));
  
    backend.subscribe(settings.get("devEui"), function(msg) {
      if (msg.packet) {
        getLocation(function(pos) {
          var packet = annotatePacket(msg.packet, pos, settings);
          packetTimer.restart();
          flashPage(pos.accuracy <= accuracyTreshold);
          runLog.append(packet);
          
          if (settings.shareResults)
            backend.report(packet);
        });
        
      } else if (msg.error) {
        var msg = msg.error.match(/authorized/) ? 
          "Invalid App EUI or Access keys" : msg.error;
        alert(msg);
        navigate("#settings")
        
      } else {
        alert(JSON.stringify(msg));
      }
    });
    
    $page.one("willhide", function(ev) {
      runLog.clear();
      packetTimer.stop();
      backend.close();
    })
  })
  .find("#stopBtn").on("click", function(ev) {
    navigate("#settings");
  })
  
  /*********************************************************************
   * Start app
   ********************************************************************/
  $(function() {
    FastClick.attach(document.body);
    // getLocation(function() {});
    navigate("#settings");
  })

  </script>
</body>
</html>